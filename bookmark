#!/usr/bin/env bash

dir=~/.config/bookmark
bookmark=$dir/list
category=$dir/category
option="Add\nDelete"
option_bookmark="New Bookmark"
option_category="New Category"

prompt(){
    rofi -dmenu $1
}

check_bookmark(){
    check=$(ls $dir | grep bookmark)
    
    if [[ -z $check ]]; then
        mkdir -p $dir
        touch $dir/list
        touch $dir/category
    fi
}
check_bookmark

add_bookmark(){
    add=$(echo -e "$option_bookmark\n$option_category" | prompt)

    if [ "$add" = "$option_bookmark" ]; then
        choose_cat=$(echo $(cat $category) | pretty | prompt)
        if [[ -z $choose_cat ]]; then
            exit
        fi
        url=$(prompt)
        if [[ -z $url ]]; then
            exit
        else
            name_url=$(prompt)
            echo "$choose_cat = $url = $name_url ;" >> $bookmark
        fi
    elif [ "$add" = "$option_category" ]; then
        new_category=$(prompt)
        echo "$new_category ;" >> $category
    fi
}

pretty(){
    sed 's/ ;/\n/g' | sed '/^$/d'
}

list_cat(){
    cat $category | pretty
}

list_book(){
    cat $bookmark | pretty
}

list(){
    list=$(echo -e "$option\n" $(cat $category) | pretty | prompt)  
    cmp=$(list_cat | grep $list | sed 's/ ;//g' )

    if [ $list = "$cmp" ]; then
        list_book | grep $list | awk -F ' = ' '{print $3}' | prompt
    else
        echo $list
    fi
}

del_bookmark(){
    del=$(echo -e "Delete Category\nDelete Bookmark" | prompt)

    if [[ -z $del ]]; then
        exit
    elif [ "$del" = "Delete Category" ]; then
        del_cat=$(list_cat | prompt)
        cat $category | sed -i "/$del_cat/d" $category
        cat $bookmark | sed -i "/$del_cat/d" $bookmark
    elif [ "$del" = "Delete Bookmark" ]; then
        cat=$(list_cat | prompt)
        if [[ -z $cat ]]; then
            exit
        fi
        del_book=$(list_book | grep $cat | awk -F ' = ' '{print $3}' | prompt)
        cat $bookmark | grep "$del_book" | sed -i "/$del_book/d" $bookmark
    fi
}

start=$(list)

if [[ -z $start ]]; then
    exit
elif [ "$start" = "Add" ]; then
    add_bookmark
elif [ "$start" = "Delete" ]; then
    del_bookmark
else
    open_url=$(cat $bookmark | grep "$start ;" | awk -F ' = ' '{print $2}')
    $BROWSER $open_url
fi
